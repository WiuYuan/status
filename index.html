<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Status Test</title>
  <style>
    button {
      display: block;
      margin: 5px 0;
      padding: 10px;
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>Status Test</h1>
  <div id="question-container"></div>

  <script type="module">
    import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.mjs";

    let pyodide;

    async function main() {
      pyodide = await loadPyodide();
      console.log("✅ Pyodide loaded");

      // 载入 Python 代码
      const statusScript = await (await fetch("status_test.py")).text();
      await pyodide.runPythonAsync(statusScript);

      // 载入 JSON 流程
      const flowJson = await (await fetch("flow.json")).text();
      pyodide.globals.set("flow_str", flowJson);

      // 启动测试
      await pyodide.runPythonAsync("run_status_test(flow_str)");
    }

    // 全局函数供 Python 调用
    window.createButtonWithHandler = (container, text, qId, answer, flow) => {
      const btn = document.createElement("button");
      btn.innerText = text;
      btn.dataset.qid = qId;
      btn.dataset.answer = answer;
      btn.dataset.flow = JSON.stringify(flow); // 存储必要信息
      
      btn.addEventListener("click", async (ev) => {
        const qId = ev.target.dataset.qid;
        const answer = ev.target.dataset.answer;
        
        // 调用 Python 处理函数
        await pyodide.runPythonAsync(`
answers['${qId}'] = '${answer}'
current_q_index += 1
show_next_question(${ev.target.dataset.flow})
`);
      });
      
      container.appendChild(btn);
    };

    main();
  </script>
</body>
</html>